---
version: 2.1

orbs:
  slack: circleci/slack@4.1.3

executors:
  pre-commit-executor:
    docker:
      - image: quay.io/astronomer/ci-pre-commit:2022-08
        environment:
          TFENV_AUTO_INSTALL: true
  terraform-executor:
    docker:
      - image: quay.io/astronomer/ci-terraform:2022-08
        environment:
          TFENV_AUTO_INSTALL: true

workflows:
  test:
    jobs:
      - run_pre_commit
  terraform_pipeline:
    jobs:
      - terraform_lint:
          context:
            - slack
      - terraform_apply:
          requires:
            - terraform_lint
          context:
            - slack
            - gcp-dev
      - terraform_destroy:
          requires:
            - terraform_apply
          context:
            - slack
            - gcp-dev
      #- git_tag:
      #    context:
      #      - github-repo
      #      - slack
      #    requires:
      #      - terraform_destroy
      #    filters:
      #      branches:
      #        only:
      #          - master

jobs:
  run_pre_commit:
    executor: pre-commit-executor
    steps:
      - checkout
      - pre-commit-commands

  terraform_lint:
    executor: pre-commit-executor
    steps:
      - checkout
      - pre-commit-commands
      - slack/notify:
          event: fail
          template: basic_fail_1

  terraform_apply:
    executor: terraform-executor
    steps:
      - checkout
      - run: EXAMPLE=from_scratch pipeline/run_terraform.sh
      - run:
          command: DESTROY=1 EXAMPLE=from_scratch pipeline/run_terraform.sh
          when: on_fail
      - slack/notify:
          event: fail
          template: basic_fail_1

  terraform_destroy:
    executor: terraform-executor
    steps:
      - checkout
      - run: DESTROY=1 EXAMPLE=from_scratch pipeline/run_terraform.sh
      - slack/notify:
          event: fail
          template: basic_fail_1

  git_tag:
    executor: terraform-executor
    steps:
      - checkout
      - run: git remote set-url origin "https://astro-astronomer:${GITHUB_TOKEN}@github.com/astronomer/${CIRCLE_PROJECT_REPONAME}.git"
      - run: git tag 1.2.<< pipeline.number >>
      - run: git push origin << pipeline.git.branch >> --tags
      - slack/notify:
          event: fail
          template: basic_fail_1
      - slack/notify:
          event: pass
          custom: |
            {
              "text": "",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Release Successful! :tada:",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Project*:\n$CIRCLE_PROJECT_REPONAME"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*When*:\n$(date +'%m/%d/%Y %T')"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Tag*:\n1.2.<< pipeline.number >>"
                    }
                  ],
                  "accessory": {
                    "type": "image",
                    "image_url": "https://assets.brandfolder.com/otz5mn-bw4j2w-6jzqo8/original/circle-logo-badge-black.png",
                    "alt_text": "CircleCI logo"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Job"
                      },
                      "url": "${CIRCLE_BUILD_URL}"
                    }
                  ]
                }
              ]
            }

commands:
  pre-commit-commands:
    description: "Execute the pre-commit"
    steps:
      - run:
          name: Create pre-commit-cache-key.txt
          command: |
            cp .pre-commit-config.yaml /tmp/pre-commit-cache-key.txt
            python --version --version | sed 's/^/# /' >> /tmp/pre-commit-cache-key.txt
      - restore_cache:
          keys:
            - pre-commit-cache-{{ checksum "/tmp/pre-commit-cache-key.txt" }}
      - terraform-install
      - run:
          name: Install terraform-docs
          command: go install github.com/terraform-docs/terraform-docs@v0.16.0
      - run:
          name: Install pre-commit hooks
          command: pre-commit install-hooks
      - save_cache:
          key: pre-commit-cache-{{ checksum "/tmp/pre-commit-cache-key.txt" }}
          paths:
            - ~/.cache/pre-commit
      - run:
          name: Run pre-commit
          command: |
            pre-commit run --all-files --show-diff-on-failure

  terraform-install:
    steps:
      - run:
          name: Install terraform
          command: |
            tfenv install
            tfenv use
